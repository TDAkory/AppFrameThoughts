# [sofa-jraft](https://github.com/sofastack/sofa-jraft)

## [`StateMachine.class`](https://github.com/sofastack/sofa-jraft/blob/master/jraft-core/src/main/java/com/alipay/sofa/jraft/StateMachine.java)

### **一、文件基本信息**

- **包路径**：`com.alipay.sofa.jraft`（SOFA JRaft 核心包）。
- **接口定位**：Raft 状态机的通用行为规范，需由业务逻辑实现具体功能。
- **设计目标**：通过定义标准化的事件回调方法，将 Raft 算法的底层逻辑与业务状态变更解耦，使开发者只需关注业务逻辑的实现。

### **二、核心方法解析**

`StateMachine` 接口包含 10 个核心方法，覆盖状态机的全生命周期和关键事件处理：

#### 1. `onApply(final Iterator iter)`

- **功能**：处理已提交的日志条目（任务），是状态机应用变更的核心入口。
- **触发条件**：当通过 `Node#apply(Task)` 提交的任务被 Raft 组多数节点持久化（即“提交”）后调用。
- **关键逻辑**：
  - 通过 `Iterator` 迭代器访问批量提交的任务。
  - 必须处理所有迭代的任务（否则会触发 `ERROR_TYPE_STATE_MACHINE` 错误）。
  - 业务逻辑（如数据写入、状态更新）在此方法中实现。
- **备注**：方法调用是串行的（非线程安全），确保任务按顺序应用，避免并发冲突。

#### 2. `onShutdown()`

- **功能**：Raft 节点关闭时的回调，用于资源清理。
- **触发条件**：节点主动关闭或异常终止时调用。
- **默认行为**：空实现，需业务方重写以释放资源（如关闭数据库连接、停止定时任务等）。

#### 3. `onSnapshotSave(final SnapshotWriter writer, final Closure done)`

- **功能**：生成状态机的快照（持久化当前状态），用于快速恢复。
- **触发条件**：Raft 节点需要创建快照时（如日志过长需要截断）。
- **关键逻辑**：
  - 通过 `SnapshotWriter` 写入快照数据（如状态机的当前内存数据）。
  - 需异步完成快照生成后调用 `done.run(status)` 通知结果。
  - **注意**：此方法会阻塞 `onApply`，需确保快照生成高效（推荐使用写时复制技术）。
- **默认行为**：不保存任何数据，返回错误。

#### 4. `onSnapshotLoad(final SnapshotReader reader)`

- **功能**：从快照恢复状态机的历史状态。
- **触发条件**：节点启动或需要从快照恢复（如新节点加入集群）。
- **关键逻辑**：
  - 通过 `SnapshotReader` 读取快照数据并加载到内存。
  - 返回 `true` 表示加载成功，否则失败（节点无法继续运行）。
- **默认行为**：不加载任何数据，返回 `false`。

#### 5. `onLeaderStart(final long term)`
- **功能**：节点成为领导者（Leader）时的回调。
- **触发条件**：Raft 选举成功，当前节点获得多数选票成为新领导者。
- **业务场景**：初始化领导者特有的资源（如启动心跳发送、分配写请求处理线程等）。
- **默认行为**：空实现。

#### 6. `onLeaderStop(final Status status)`

- **功能**：节点失去领导者身份时的回调。
- **触发条件**：领导者任期结束（如选举失败、网络分区导致无法维持多数派）。
- **业务场景**：清理领导者相关资源（如停止心跳发送、释放独占锁等）。
- **参数**：`status` 描述下台原因（如超时、错误）。

#### 7. `onError(final RaftException e)`
- **功能**：节点遇到严重错误时的回调。
- **触发条件**：Raft 算法执行过程中出现不可恢复错误（如日志持久化失败、网络异常）。
- **关键逻辑**：
  - 错误发生后，节点将停止处理任何修改操作，直到重启并修复错误。
  - 需在此记录错误日志或触发告警。

#### 8. `onConfigurationCommitted(final Configuration conf)`

- **功能**：集群配置变更（如节点加入/退出）被提交时的回调。
- **触发条件**：配置变更的日志被多数节点持久化（即“提交”）。
- **业务场景**：更新本地维护的集群成员列表（如更新负载均衡规则、调整副本策略）。
- **参数**：`conf` 是已提交的新配置（包含节点地址、角色等信息）。

#### 9. `onStopFollowing(final LeaderChangeContext ctx)`

- **功能**：跟随者（Follower）停止跟随当前领导者时的回调。
- **触发条件**：
  - 选举超时，触发预投票（PreVote）。
  - 收到更高任期的请求（如候选者的投票请求、新领导者的追加日志请求）。
  - 收到领导者的 `timeoutNow` 请求，触发重新选举。
- **参数**：`ctx` 包含前领导者的上下文（如领导者 ID、任期、状态）。
- **业务场景**：重置与旧领导者相关的状态（如清理过时的租约、取消未完成的请求）。

#### 10. `onStartFollowing(final LeaderChangeContext ctx)`

- **功能**：跟随者开始跟随新领导者时的回调。
- **触发条件**：
  - 候选者收到新领导者的追加日志请求，转为跟随者。
  - 无领导者的跟随者收到新领导者的追加日志请求。
- **参数**：`ctx` 包含新领导者的上下文（如领导者 ID、任期、状态）。
- **业务场景**：同步新领导者的状态（如更新心跳超时时间、注册领导者监听）。

### **三、设计特点总结**

- **事件驱动**：通过回调方法响应 Raft 算法的关键事件（如日志提交、领导者变更），解耦底层协议与业务逻辑。
- **状态一致性**：`onApply` 确保任务按顺序应用，`onSnapshotSave/Load` 支持状态持久化与快速恢复，共同保障分布式状态一致。
- **扩展性**：默认方法为空或错误实现，业务方可根据需求选择性重写，灵活适配不同场景（如数据库、缓存、分布式协调服务）。

### **四、典型使用场景**

- **数据库复制**：通过 `onApply` 应用写请求日志，确保所有节点数据库状态一致。
- **分布式锁**：通过 `onLeaderStart` 初始化锁服务，`onApply` 处理锁申请/释放请求。
- **配置中心**：通过 `onConfigurationCommitted` 更新集群配置，`onSnapshotSave` 定期备份配置状态。
